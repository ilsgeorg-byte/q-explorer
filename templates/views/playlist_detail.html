<section class="playlist-detail animate-in">
    <div class="playlist-header glass-card">
        <div class="playlist-cover">
            {% if playlist.items %}
            {% set ns = namespace(found=[]) %}
            {% for item in playlist.items %}
            {% if item.image_url not in ns.found and ns.found|length < 4 %} {% set ns.found=ns.found + [item.image_url]
                %} {% endif %} {% endfor %} <div class="art-collage">
                {% for img in ns.found %}
                <img src="{{ img|replace('100x100bb', '600x600bb') }}" loading="lazy"
                    onload="if({{ 'true' if loop.first else 'false' }}) applyDynamicColors(this.src)">
                {% endfor %}
        </div>
        {% else %}
        <p class="empty-msg">No tracks in this playlist yet.</p>
        {% endif %}
    </div>

    <div class="playlist-meta">
        <span class="label">Playlist</span>
        <h1>{{ playlist.name }}</h1>
        {% if playlist.description %}
        <p class="description">{{ playlist.description }}</p>
        {% endif %}
        <div class="stats">
            <span>Created by <strong>{{ playlist.owner.username }}</strong></span>
            <span class="dot">â€¢</span>
            <span>{{ playlist.items|length }} tracks</span>
            <span class="dot">â€¢</span>
            <span style="opacity: 0.6;">{{ playlist.created_at.strftime('%d.%m.%Y') }}</span>
        </div>
        <div class="actions">
            <button class="btn-premium btn-premium-primary" onclick="playPlaylist({{ playlist.id }})">
                <span style="font-size: 10px; margin-right: 8px;">â–¶</span> Listen All
            </button>
            <button class="btn-premium"
                onclick="window.confirmDelete = true; deletePlaylist({{ playlist.id }}, true)">Delete Playlist</button>
        </div>

        <div class="playlist-advanced-actions" style="margin-top: 15px; display: flex; gap: 10px;">
            <button class="btn-glass" onclick="extendPlaylist({{ playlist.id }})"
                style="font-size: 13px; padding: 8px 15px;">
                âœ¨ Extend Playlist (Magic)
            </button>
            <button class="btn-glass" onclick="openShareCard()" style="font-size: 13px; padding: 8px 15px;">
                ðŸ“¤ Share Card
            </button>
        </div>
    </div>
    </div>

    <div class="tracks-container">
        {% if playlist.items %}
        <div class="song-list-compact">
            {% for item in playlist.items|sort(attribute='position') %}
            {% set parts = item.track_id.split('|') %}
            {% set album_id = parts[0] %}
            <div class="track-row-compact" data-item-id="{{ item.id }}"
                onclick="openMusicModal('', '', '{{ item.track_id }}', '', '{{ item.title|replace('\'', '&#39;') }}', '{{ item.artist_name|replace('\'', '&#39;') }}', '{{ item.image_url }}')">

                <div class="track-index">{{ loop.index }}</div>

                <div class="track-info-compact">
                    <div class="track-title-compact">{{ item.title }}</div>
                    <div class="track-artist-compact">{{ item.artist_name }}</div>
                </div>

                <!-- RIGHT SIDE: CLICKABLE ALBUM ARTWORK -->
                {% set album_id = item.track_id.split('|')[0] if '|' in item.track_id else '' %}
                <div class="track-art-compact"
                    onclick="event.stopPropagation(); if('{{ album_id }}') window.location.href='/album/{{ album_id }}'"
                    title="Go to Album">
                    <img src="{{ item.image_url }}" alt="{{ item.title }}" loading="lazy">
                </div>

                <button class="btn-remove-track"
                    onclick="event.stopPropagation(); removeFromPlaylist({{ playlist.id }}, '{{ item.track_id }}')"
                    title="Remove from playlist">âœ•</button>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="empty-tracks glass-card">
            <p>This playlist has no tracks yet. Add something from the search!</p>
            <a href="/" class="btn-premium btn-premium-glass">Find Music</a>
        </div>
        {% endif %}
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            initPlaylistSortable({{ playlist.id }});
        });
    </script>
</section>