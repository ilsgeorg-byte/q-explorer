<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Q-Explorer</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üéµ</text></svg>">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Pirata+One&display=swap" rel="stylesheet">
</head>
<body>

    <!-- –ó–ê–ì–†–£–ó–ß–ò–ö -->
    <div id="global-loader">
        <div class="spinner"></div>
    </div>

    <!-- –ü–û–ò–°–ö -->
    <div class="search-container">
        <div class="header">
            <a href="/" class="logo">Q-Explorer<span>.</span></a>
        </div>
        <form action="/" method="get" class="search-wrapper" onsubmit="saveHistory(this.q.value)">
            <input type="text" name="q" placeholder="Search..." value="{{ query if query else '' }}" autocomplete="off" onfocus="showHistory()">
            <button type="submit">GO</button>
            <div id="history-dropdown"></div>
        </form>
    </div>

    <!-- –ò–ó–ë–†–ê–ù–ù–û–ï -->
    <div id="favorites-section">
        <div class="fav-header">
            <div class="fav-title">‚ù§Ô∏è My Favorites</div>
            <div class="fav-controls">
                <span class="fav-btn-action" onclick="toggleFavsView()" id="fav-toggle-btn">See All</span>
                <span class="fav-btn-action" onclick="clearFavs()">Clear</span>
            </div>
        </div>
        <div id="favorites-container" class="scroll-row"></div>
    </div>

    <!-- –ú–û–î–ê–õ–ö–ê -->
    <div id="music-modal" onclick="closeMusicModal()">
        <div class="modal-content" onclick="event.stopPropagation()">
            <div class="modal-title">Listen on...</div>
            <a id="modal-spotify" href="#" target="_blank" class="modal-btn m-spotify">Spotify</a>
            <a id="modal-apple" href="#" target="_blank" class="modal-btn m-apple">Apple Music</a>
            <div class="modal-btn m-cancel" onclick="closeMusicModal()">Cancel</div>
        </div>
    </div>

    <!-- HOME -->
    {% if view == 'home' %}
    <div class="empty-state">
        <div style="font-size: 60px; margin-bottom: 20px;">üéµ</div>
        Start searching for music
    </div>
    {% endif %}

    <!-- RESULTS -->
    {% if view == 'results' %}
        
        <!-- Artists -->
        {% if data.artists %}
        <div class="section-header">
            <h2 class="section-title">Artists</h2>
            <a href="/see-all/artists?q={{ query }}" class="btn-see-all">See All</a>
        </div>
        <div class="grid">
            {% for item in data.artists %}
            <a href="/artist/{{ item.artistId }}" class="card artist-card">
                <div class="btn-like" onclick="toggleLike(this, 'artist', '{{ item.artistId }}', '{{ item.artistName|replace('\'', '\\\'') }}', '{{ item.image }}', '{{ item.primaryGenreName }}', '')">‚ô•</div>
                
                <div class="artist-img-wrapper" data-artist-id="{{ item.artistId }}">
                    {% if item.image %}
                        <img src="{{ item.image }}">
                    {% else %}
                        <div class="artist-placeholder" style="background-color: hsl({{ (item.artistName|length * 50) % 360 }}, 60%, 40%);">
                            {{ item.artistName[:1] }}
                        </div>
                    {% endif %}
                </div>
                
                <div class="info">
                    <div class="title">{{ item.artistName }}</div>
                    {% if item.stats %}<span class="artist-stats">{{ item.stats }}</span>{% endif %}
                </div>
            </a>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Albums -->
        {% if data.albums %}
        <div class="section-header">
            <h2 class="section-title">Albums</h2>
            <a href="/see-all/albums?q={{ query }}" class="btn-see-all">See All</a>
        </div>
        <div class="grid">
            {% for item in data.albums %}
            <a href="/album/{{ item.collectionId }}" class="card">
                <div class="btn-like" onclick="toggleLike(this, 'album', '{{ item.collectionId }}', '{{ item.collectionName|replace('\'', '\\\'') }}', '{{ item.artworkUrl100 }}', '{{ item.artistName|replace('\'', '\\\'') }}', '')">‚ô•</div>
                <img src="{{ item.artworkUrl100 }}">
                <div class="info">
                    <div class="title">{{ item.collectionName }}</div>
                    <div class="sub">
                        {{ item.artistName }} 
                        {% if item.year %}‚Ä¢ {{ item.year }}{% endif %}
                    </div>
                </div>
            </a>
            {% endfor %}
        </div>
        {% endif %}

        <!-- Songs -->
        {% if data.songs %}
        <div class="section-header">
            <h2 class="section-title">Songs</h2>
            <a href="/see-all/songs?q={{ query }}" class="btn-see-all">See All</a>
        </div>
        <div class="song-list">
            {% for item in data.songs %}
            <div class="song-row" onclick="openMusicModal('{{ item.spotify_link }}', '{{ item.collectionId }}', '{{ item.trackId }}')">
                <img src="{{ item.artworkUrl100 }}" class="song-img">
                <div class="song-info">
                    <div class="song-title">{{ item.trackName }}</div>
                    <div class="song-artist">{{ item.artistName }}</div>
                </div>
                <div class="song-like btn-like" onclick="toggleLike(this, 'song', '{{ item.trackId }}', '{{ item.trackName|replace('\'', '\\\'') }}', '{{ item.artworkUrl100 }}', '{{ item.artistName|replace('\'', '\\\'') }}', '{{ item.spotify_link }}')">‚ô•</div>
            </div>
            {% endfor %}
        </div>
        {% endif %}
    {% endif %}

    <!-- SEE ALL -->
    {% if view == 'see_all' %}
    <div class="page-header">
        <a href="/?q={{ query }}" class="btn-see-all" style="margin-bottom:10px; display:inline-block;">‚Üê Back to Search</a>
        <h1 style="font-size: 24px; margin-bottom: 20px;">All {{ type|capitalize }} for "{{ query }}"</h1>
    </div>
    
    {% if not results %}
        <div style="text-align:center; padding: 40px; color:#666;">No results found.</div>
    {% else %}
    
    {% if type == 'songs' %}
        <div class="song-list">
            {% for item in results %}
             <div class="song-row" onclick="openMusicModal('{{ item.spotify_link }}', '{{ item.collectionId }}', '{{ item.trackId }}')">
                <img src="{{ item.artworkUrl100 }}" class="song-img">
                <div class="song-info">
                    <div class="song-title">{{ item.trackName }}</div>
                    <div class="song-artist">{{ item.artistName }}</div>
                </div>
                <div class="song-like btn-like" onclick="toggleLike(this, 'song', '{{ item.trackId }}', '{{ item.trackName|replace('\'', '\\\'') }}', '{{ item.artworkUrl100 }}', '{{ item.artistName|replace('\'', '\\\'') }}', '{{ item.spotify_link }}')">‚ô•</div>
            </div>
            {% endfor %}
        </div>
    {% else %}
        <div class="grid">
            {% for item in results %}
                {% if type == 'artists' %}
                <a href="/artist/{{ item.artistId }}" class="card artist-card">
                     <div class="btn-like" onclick="toggleLike(this, 'artist', '{{ item.artistId }}', '{{ item.artistName|replace('\'', '\\\'') }}', '{{ item.image }}', '{{ item.primaryGenreName }}', '')">‚ô•</div>
                    
                    <!-- WRAPPER –î–õ–Ø –õ–ï–ù–ò–í–û–ô –ó–ê–ì–†–£–ó–ö–ò -->
                    <div class="artist-img-wrapper" data-artist-id="{{ item.artistId }}">
                        {% if item.image %}
                            <img src="{{ item.image }}">
                        {% else %}
                            <div class="artist-placeholder" style="background-color: hsl({{ (item.artistName|length * 50) % 360 }}, 60%, 40%);">
                                {{ item.artistName[:1] }}
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="info"><div class="title">{{ item.artistName }}</div></div>
                </a>
                {% elif type == 'albums' %}
                <a href="/album/{{ item.collectionId }}" class="card">
                     <div class="btn-like" onclick="toggleLike(this, 'album', '{{ item.collectionId }}', '{{ item.collectionName|replace('\'', '\\\'') }}', '{{ item.artworkUrl100 }}', '{{ item.artistName|replace('\'', '\\\'') }}', '')">‚ô•</div>
                    <img src="{{ item.artworkUrl100 }}">
                    <div class="info">
                        <div class="title">{{ item.collectionName }}</div>
                        <div class="sub">
                            {{ item.artistName }} 
                            {% if item.year %}‚Ä¢ {{ item.year }}{% endif %}
                        </div>
                    </div>
                </a>
                {% endif %}
            {% endfor %}
        </div>
    {% endif %}
    {% endif %}
    {% endif %}

    <!-- ARTIST DETAIL -->
    {% if view == 'artist_detail' %}
    <div class="page-header">
        <a href="javascript:history.back()" class="btn-see-all" style="margin-bottom:20px; display:inline-block;">‚Üê Back</a>
        <span class="btn-see-all" onclick="sharePage()" style="margin-left: 20px; cursor: pointer;">üîó Share</span>
    </div>
       <div class="artist-hero">
        {% if artist_image %}<img src="{{ artist_image }}">{% endif %}
        <h1>{{ artist.artistName }}</h1>
        
        <!-- –¢—ç–≥–∏ –≤–º–µ—Å—Ç–æ —Å–∫—É—á–Ω–æ–≥–æ –∂–∞–Ω—Ä–∞ -->
        <div class="genre">
    {{ artist.primaryGenreName }}
    {% if artist.tags %}
        {% for tag in artist.tags %}
            <!-- –¢–ï–ü–ï–†–¨ –≠–¢–û –°–°–´–õ–ö–ê -->
            <a href="/tag/{{ tag }}" style="color: inherit; text-decoration: none;" title="Browse {{ tag }}">
                <span style="opacity: 0.6; margin-left: 5px; cursor: pointer; transition: opacity 0.2s;" 
                      onmouseover="this.style.opacity=1" 
                      onmouseout="this.style.opacity=0.6">
                            ‚Ä¢ {{ tag|capitalize }}
                        </span>
                    </a>
                {% endfor %}
            {% endif %}
        </div>

        
        {% if artist.stats %}<div class="stats-hero">{{ artist.stats }}</div>{% endif %}
        
        <!-- –ë–ò–û–ì–†–ê–§–ò–Ø -->
        {% if artist.bio %}
        <div style="max-width: 600px; margin: 15px auto; font-size: 14px; color: #ccc; line-height: 1.5;">
            {{ artist.bio }}
        </div>
        {% endif %}
    </div>

    <!-- –¢–û–ü –ü–ï–°–ù–ò (–°—Ä–∞–∑—É –ø–æ—Å–ª–µ Hero) -->
    {% if top_songs %}
    <div class="section-header"><h2 class="section-title">Top Songs</h2></div>
    <div class="song-list" style="margin-bottom: 30px;">
        {% for song in top_songs %}
        <div class="song-row" onclick="openMusicModal('{{ song.spotify_link }}', '{{ song.collectionId }}', '{{ song.trackId }}')">
            <img src="{{ song.artworkUrl100 }}" class="song-img">
            <div class="song-info">
                <div class="song-title">{{ song.trackName }}</div>
                <div class="song-artist" style="opacity: 0.7;">{{ song.collectionName }}</div>
            </div>
            <!-- –õ–∞–π–∫ -->
             <div class="btn-like song-like" onclick="toggleLike(this, 'song', '{{ song.trackId }}', '{{ song.trackName|replace('\'', '\\\'') }}', '{{ song.artworkUrl100 }}', '{{ song.artistName|replace('\'', '\\\'') }}', '{{ song.spotify_link }}')">‚ô•</div>
        </div>
        {% endfor %}
    </div>
    {% endif %}

    {% if similar %}
    <div class="similar-artists">
        <h3>Fans also like</h3>
        <div class="scroll-row">
            {% for sim in similar %}
            <a href="/?q={{ sim.name }}" class="similar-card">
                <div class="sim-circle">{{ sim.name[:1] }}</div>
                <span>{{ sim.name }}</span>
            </a>
            {% endfor %}
        </div>
    </div>
    {% endif %}
    {% for cat, items in discography.items() %}
        {% if items %}
        <div class="section-header"><h2 class="section-title">{{ cat|capitalize }}</h2></div>
        <div class="grid">
            {% for item in items %}
            <a href="/album/{{ item.collectionId }}" class="card">
                <div class="btn-like" onclick="toggleLike(this, 'album', '{{ item.collectionId }}', '{{ item.collectionName|replace('\'', '\\\'') }}', '{{ item.artworkUrl100 }}', '{{ item.artistName|replace('\'', '\\\'') }}', '')">‚ô•</div>
                <img src="{{ item.artworkUrl100 }}">
                <div class="info"><div class="title">{{ item.collectionName }}</div><div class="sub">{{ item.releaseDate[:4] }}</div></div>
            </a>
            {% endfor %}
        </div>
        {% endif %}
    {% endfor %}
    {% endif %}

    <!-- ALBUM DETAIL -->
    {% if view == 'album_detail' %}
    <div class="page-header">
        <a href="javascript:history.back()" class="btn-see-all" style="margin-bottom:20px; display:inline-block;">‚Üê Back</a>
        <span class="btn-see-all" onclick="sharePage()" style="margin-left: 20px; cursor: pointer;">üîó Share</span>
    </div>
    <div class="hero">
        <img src="{{ album.artworkUrl100 }}">
        <div class="hero-info">
            <h1>{{ album.collectionName }}</h1>
            <div class="sub">{{ album.artistName }} ‚Ä¢ {{ album.releaseDate[:4] }}</div>
            {% if album_stats %}<div class="hero-stats">{{ album_stats }}</div>{% endif %}
            <div class="actions">
                <a href="{{ spotify_link }}" target="_blank" class="btn btn-spotify">Spotify</a>
                <a href="https://music.apple.com/album/{{ album.collectionId }}" target="_blank" class="btn btn-apple">Apple Music</a>
            </div>
        </div>
    </div>
    <div class="song-list">
        {% for song in songs %}
        <div class="track" style="position: relative;" onclick="openMusicModal('{{ song.spotify_link }}', '{{ album.collectionId }}', '{{ song.trackId }}')">
            <div class="t-num">{{ song.trackNumber }}</div>
            <div class="t-name">{{ song.trackName }}</div>
            <div class="btn-like song-like" 
                 onclick="toggleLike(this, 'song', '{{ song.trackId }}', '{{ song.trackName|replace('\'', '\\\'') }}', '{{ album.artworkUrl100 }}', '{{ album.artistName|replace('\'', '\\\'') }}', '{{ song.spotify_link }}')">
                ‚ô•
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- === –ù–û–í–´–ô –ë–õ–û–ö: –°–¢–†–ê–ù–ò–¶–ê –ñ–ê–ù–†–ê === -->
        {% elif view == 'tag_detail' %}
        <div class="artist-hero">
            <h1 style="font-size: 56px; margin-bottom: 20px;">{{ tag_name|capitalize }}</h1>
            <div style="max-width:800px; margin:0 auto; font-size:16px; color:#ccc; line-height: 1.6;">{{ description|safe }}</div>
        </div>
        
        <!-- Controls Container -->
        <div style="max-width: 1200px; margin: 40px auto 20px; padding: 0 20px; display:flex; justify-content:space-between; align-items:center;">
            <div class="sort-controls">
                <span style="color:#666; margin-right:10px;">Sort by:</span>
                <a href="/tag/{{ tag_name }}?page=1&sort=popularity" style="color: {% if sort_by == 'popularity' %}#fff{% else %}#888{% endif %}; margin-right:15px; font-weight: bold;">Popularity</a>
                <a href="/tag/{{ tag_name }}?page=1&sort=alpha" style="color: {% if sort_by == 'alpha' %}#fff{% else %}#888{% endif %}; font-weight: bold;">A-Z</a>
            </div>
            
            <div class="pagination">
                {% if page > 1 %}
                <a href="/tag/{{ tag_name }}?page={{ page - 1 }}&sort={{ sort_by }}" style="background:#333; padding:8px 20px; border-radius:20px; font-size:14px; margin-right: 15px;">‚Üê Prev</a>
                {% endif %}
                <span style="color:#666;">Page {{ page }}</span>
                <a href="/tag/{{ tag_name }}?page={{ page + 1 }}&sort={{ sort_by }}" style="background:#333; padding:8px 20px; border-radius:20px; font-size:14px; margin-left: 15px;">Next ‚Üí</a>
            </div>
        </div>

        <!-- Grid -->
        <div class="grid" style="max-width: 1200px; margin: 0 auto; padding: 0 20px;">
            {% for artist in artists %}
            <a href="/?q={{ artist.artistName }}" class="card">
                <div class="card-img-wrapper">
                    <!-- –¶–≤–µ—Ç–Ω–æ–π –∫–≤–∞–¥—Ä–∞—Ç —Å –ø–µ—Ä–≤–æ–π –±—É–∫–≤–æ–π –∏–º–µ–Ω–∏ -->
                    <div class="card-img lazy-grad" style="width:100%; height:100%; display:flex; align-items:center; justify-content:center; font-size: 48px; font-weight: bold; color: rgba(255,255,255,0.2);">
                        {{ artist.artistName[0]|upper }}
                    </div>
                </div>
                <div class="card-title">{{ artist.artistName }}</div>
                <!-- –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —á–∏—Å–ª–æ: 1,234,567 -> 1.2M -->
                <div class="card-subtitle">
                    {% if artist.listeners > 1000000 %}
                        {{ (artist.listeners / 1000000)|round(1) }}M Listeners
                    {% else %}
                        {{ (artist.listeners / 1000)|round|int }}K Listeners
                    {% endif %}
                </div>
            </a>
            {% endfor %}
        </div>


    {% endif %}

    <!-- –ö–ù–û–ü–ö–ê –ù–ê–í–ï–†–• –ò –¢–û–°–¢ -->
    <div id="scroll-top" onclick="window.scrollTo({top: 0, behavior: 'smooth'})">‚Üë</div>
    <div id="toast">Link copied!</div>

    <script src="{{ url_for('static', filename='script.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => { 
            renderFavorites(); 
            checkLikedStatus();
            
            // –ü–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä —Å –ø–æ–¥—Å–∫–∞–∑–∫–∞–º–∏
            const hints = ["Pink Floyd", "Metallica", "Taylor Swift", "Queen", "Hans Zimmer", "The Beatles", "Eminem"];
            const input = document.querySelector('input[name="q"]');
            if(input) input.placeholder = "Try: " + hints[Math.floor(Math.random() * hints.length)];
            
            // –ö–Ω–æ–ø–∫–∞ –Ω–∞–≤–µ—Ä—Ö
            window.addEventListener('scroll', () => {
                const btn = document.getElementById('scroll-top');
                if (window.scrollY > 300) btn.style.display = 'flex';
                else btn.style.display = 'none';
            });
            
            // LAZY LOADING IMAGES (–í–∞–∂–Ω–∞—è —á–∞—Å—Ç—å!)
            const wrappers = document.querySelectorAll('.artist-img-wrapper');
            const loadImage = (wrapper) => {
                const artistId = wrapper.getAttribute('data-artist-id');
                // –ï—Å–ª–∏ –Ω–µ—Ç ID –∏–ª–∏ —É–∂–µ –µ—Å—Ç—å –∫–∞—Ä—Ç–∏–Ω–∫–∞, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º
                if (!artistId || wrapper.querySelector('img')) return;

                fetch(`/api/get-artist-image/${artistId}`)
                    .then(response => response.json())
                    .then(data => {
                        if (data.image) {
                            const img = document.createElement('img');
                            img.src = data.image;
                            img.style.opacity = '0'; // –°–∫—Ä—ã—Ç–∞
                            img.style.transition = 'opacity 0.5s'; // –ü–ª–∞–≤–Ω–æ–µ –ø–æ—è–≤–ª–µ–Ω–∏–µ
                            img.onload = () => { img.style.opacity = '1'; };
                            
                            wrapper.innerHTML = ''; // –£–±–∏—Ä–∞–µ–º –ø–ª–µ–π—Å—Ö–æ–ª–¥–µ—Ä
                            wrapper.appendChild(img);
                        }
                    })
                    .catch(err => console.log('No image for', artistId));
            };

            // –ó–∞–ø—É—Å–∫–∞–µ–º –æ—á–µ—Ä–µ–¥—å —Å –∑–∞–¥–µ—Ä–∂–∫–æ–π 300–º—Å
            wrappers.forEach((wrapper, index) => {
                setTimeout(() => {
                    loadImage(wrapper);
                }, index * 300);
            });
        });

        // –õ–û–ê–î–ï–†
        document.querySelector('form').addEventListener('submit', () => {
            document.getElementById('global-loader').style.display = 'flex';
        });
        document.querySelectorAll('a').forEach(link => {
            link.addEventListener('click', (e) => {
                const href = link.getAttribute('href');
                if (href && !href.startsWith('#') && !href.startsWith('javascript') && link.target !== '_blank') {
                    document.getElementById('global-loader').style.display = 'flex';
                }
            });
        });
        window.addEventListener('pageshow', () => {
            document.getElementById('global-loader').style.display = 'none';
        });
        
        // SHARE
        function sharePage() {
            navigator.clipboard.writeText(window.location.href);
            const toast = document.getElementById('toast');
            toast.style.display = 'block';
            setTimeout(() => toast.style.display = 'none', 2000);
        }


                // –î–æ–±–∞–≤—å—Ç–µ —ç—Ç–æ –≤–Ω—É—Ç—Ä—å —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ <script>
        document.querySelectorAll('.lazy-grad').forEach(div => {
            const hue = Math.floor(Math.random() * 360);
            div.style.background = `linear-gradient(135deg, hsl(${hue}, 40%, 20%), hsl(${hue + 40}, 50%, 40%))`;
        });

    </script>
</body>
</html>
