<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Explorer</title>
    <!-- Готический шрифт -->
    <link href="https://fonts.googleapis.com/css2?family=Pirata+One&display=swap" rel="stylesheet">
    <!-- Ссылка на стили -->
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <!-- Ссылка на скрипт -->
    <script src="{{ url_for('static', filename='script.js') }}" defer></script>
</head>
<body>
    <div class="header">
        <a href="/" class="logo">Q-Explorer<span>.</span></a>
        <div class="search-container">
            <form action="/" method="GET">
                <input type="text" name="q" class="search-input" placeholder="Try: Pink Floyd, Queen..." value="{{ query|default('') }}">
            </form>
        </div>
    </div>

    <!-- === HOME === -->
    {% if view == 'home' %}
        <div class="home-container">
            <h1>Discover Music</h1>
            <p>Search for your favorite artists above.</p>
        </div>
    
    <!-- === SEARCH RESULTS === -->
    {% elif view == 'results' %}
        {% if data.artists %}
        <div class="section-header"><h2>Artists</h2><a href="/see-all/artists?q={{ query }}" class="see-all-link">SEE ALL</a></div>
        <div class="grid">
            {% for artist in data.artists %}
            <a href="/artist/{{ artist.artistId }}" class="card">
                <div class="card-img-wrapper circle-img"><img src="{{ artist.image or '/static/placeholder.png' }}" class="card-img circle-img"></div>
                <div class="card-title">{{ artist.artistName }}</div>
                <div class="card-subtitle">{{ artist.stats or 'Artist' }}</div>
            </a>
            {% endfor %}
        </div>
        {% endif %}
        
        {% if data.albums %}
        <div class="section-header"><h2>Albums</h2><a href="/see-all/albums?q={{ query }}" class="see-all-link">SEE ALL</a></div>
        <div class="grid">
            {% for alb in data.albums %}
            <a href="/album/{{ alb.collectionId }}" class="card">
                <div class="card-img-wrapper"><img src="{{ alb.artworkUrl100 }}" class="card-img"></div>
                <div class="card-title">{{ alb.collectionName }}</div>
                <div class="card-subtitle">{{ alb.year }} • {{ alb.artistName }}</div>
            </a>
            {% endfor %}
        </div>
        {% endif %}

        {% if data.songs %}
        <div class="section-header"><h2>Songs</h2><a href="/see-all/songs?q={{ query }}" class="see-all-link">SEE ALL</a></div>
        <div class="song-list">
            {% for song in data.songs %}
            <div class="song-row" onclick="openMusicModal('{{ song.spotify_link }}')">
                <img src="{{ song.artworkUrl100 }}" class="song-img">
                <div class="song-info"><div class="song-title">{{ song.trackName }}</div><div class="song-subtitle">{{ song.artistName }}</div></div>
                <div class="btn-like">♥</div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

    <!-- === ARTIST DETAIL === -->
    {% elif view == 'artist_detail' %}
        <div class="artist-hero">
            {% if artist_image %}<img src="{{ artist_image }}">{% endif %}
            <h1>{{ artist.artistName }}</h1>
            
            <div class="genre">
                {{ artist.primaryGenreName }}
                {% if artist.tags %}
                    {% for tag in artist.tags %}
                        <a href="/tag/{{ tag }}" class="tag-link" title="Browse {{ tag }}">
                            <span>• {{ tag|capitalize }}</span>
                        </a>
                    {% endfor %}
                {% endif %}
            </div>

            {% if artist.stats %}<div class="stats-hero">{{ artist.stats }}</div>{% endif %}
            {% if artist.bio %}<div class="bio-text">{{ artist.bio|safe }}</div>{% endif %}
        </div>

        {% if top_songs %}
        <div class="section-header"><h2>Top Songs</h2></div>
        <div class="song-list" style="margin-bottom:30px;">
            {% for song in top_songs %}
            <div class="song-row" onclick="openMusicModal('{{ song.spotify_link }}')">
                <div class="song-num">{{ loop.index }}</div>
                <img src="{{ song.artworkUrl100 }}" class="song-img">
                <div class="song-info"><div class="song-title">{{ song.trackName }}</div><div class="song-subtitle">{{ song.collectionName }}</div></div>
                <div class="btn-like">♥</div>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% for cat, items in discography.items() %}
            {% if items %}
            <div class="section-header"><h2>{{ cat|capitalize }}</h2></div>
            <div class="grid">
                {% for alb in items %}
                <a href="/album/{{ alb.collectionId }}" class="card">
                    <div class="card-img-wrapper"><img src="{{ alb.artworkUrl100 }}" class="card-img"></div>
                    <div class="card-title">{{ alb.collectionName }}</div>
                    <div class="card-subtitle">{{ alb.year }}</div>
                </a>
                {% endfor %}
            </div>
            {% endif %}
        {% endfor %}

    <!-- === ALBUM DETAIL === -->
    {% elif view == 'album_detail' %}
        <div class="album-hero">
            <img src="{{ album.artworkUrl100 }}" class="album-cover-big">
            <div class="album-meta">
                <h2>Album</h2>
                <h1>{{ album.collectionName }}</h1>
                <div><a href="/artist/{{ album.artistId }}">{{ album.artistName }}</a> • {{ album.year }}</div>
                {% if album_stats %}<div style="color:#ccc; margin-top:10px;">{{ album_stats }}</div>{% endif %}
            </div>
        </div>
        <div class="song-list">
            {% for song in songs %}
            <div class="song-row" onclick="openMusicModal('{{ song.spotify_link }}')">
                <div class="song-num">{{ song.trackNumber }}</div>
                <div class="song-info"><div class="song-title">{{ song.trackName }}</div><div class="song-subtitle">{{ song.artistName }}</div></div>
                <div class="btn-like">♥</div>
            </div>
            {% endfor %}
        </div>
    
    <!-- === TAG (GENRE) DETAIL === -->
    {% elif view == 'tag_detail' %}
        <div class="artist-hero">
            <h1 class="tag-title">{{ tag_name|capitalize }}</h1>
            <div class="bio-text">{{ description|safe }}</div>
        </div>
        
        <!-- Controls -->
        <div class="tag-controls">
            <div class="sort-controls">
                <span style="color:#666; margin-right:10px;">Sort by:</span>
                <a href="/tag/{{ tag_name }}?page=1&sort=popularity" class="sort-link {% if sort_by == 'popularity' %}active{% endif %}">Popularity</a>
                <a href="/tag/{{ tag_name }}?page=1&sort=alpha" class="sort-link {% if sort_by == 'alpha' %}active{% endif %}">A-Z</a>
            </div>
            
            <div class="pagination">
                {% if page > 1 %}
                <a href="/tag/{{ tag_name }}?page={{ page - 1 }}&sort={{ sort_by }}" class="page-btn">← Prev</a>
                {% endif %}
                <span style="color:#666;">Page {{ page }}</span>
                <a href="/tag/{{ tag_name }}?page={{ page + 1 }}&sort={{ sort_by }}" class="page-btn">Next →</a>
            </div>
        </div>

        <!-- Grid -->
        <div class="tag-grid">
            {% for artist in artists %}
            <a href="/?q={{ artist.artistName }}" class="card">
                <div class="card-img-wrapper">
                    <!-- Заглушка для JS -->
                    <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" 
                         class="card-img lazy-load-by-name" 
                         data-name="{{ artist.artistName }}"
                         style="background: #333;">
                </div>
                
                <div class="card-title">{{ artist.artistName }}</div>
                
                <div class="card-subtitle">
                    {% if artist.listeners > 0 %}
                        {% if artist.listeners > 1000000 %}
                            {{ (artist.listeners / 1000000)|round(1) }}M Listeners
                        {% else %}
                            {{ (artist.listeners / 1000)|round|int }}K Listeners
                        {% endif %}
                    {% else %}
                        Artist
                    {% endif %}
                </div>
            </a>
            {% endfor %}
        </div>
    {% endif %}

    <!-- MODAL -->
    <div id="modal">
        <div class="modal-content">
            <h2>Play Track</h2>
            <a id="spotify-link" href="#" target="_blank" class="btn-spotify">Open in Spotify</a>
            <br><br><button id="close-modal-btn" style="background:transparent; border:1px solid #555; color:#fff; padding:8px 16px; border-radius:20px; cursor:pointer;">Close</button>
        </div>
    </div>

</body>
</html>
